%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% convert a rgb image to a lab image
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function lab = rgb2lab(rgb)

xyz = rgb2xyz(rgb);

xyz(:, :, 1) = xyz(:, :, 1) ./ 95.047;
xyz(:, :, 2) = xyz(:, :, 2) ./ 100.000;
xyz(:, :, 3) = xyz(:, :, 3) ./ 108.883;

for i = 1:3
    cc = xyz(:, :, i);
    
    inds = find(cc > 0.008856);
    cc(inds) = cc(inds).^(1.0 / 3.0);
    
    inds = find(cc <= 0.008856);
    cc(inds) = ( 903.3 * cc(inds) + 16.0 ) / 116.0;
    
    xyz(:, :, i) = cc;
end

lab(:, :, 1) = ( 116.0 * xyz(:, :, 2) ) - 16.0;
lab(:, :, 2) = 500.0 * ( xyz(:, :, 1) - xyz(:, :, 2) );
lab(:, :, 3) = 200.0 * ( xyz(:, :, 2) - xyz(:, :, 3) );

end % function rgb2lab


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% convert a rgb image to a xyz image
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function xyz = rgb2xyz(rgb)

M = [0.412424 0.212656 0.0193324; 0.357579 0.715158 0.119193; 0.180464 0.0721856 0.950444];

if isinteger(rgb) == 1
    rgb = double(rgb) / 255;
end

% for i = 1:3
%     cc = rgb(:, :, i);
%     
%     inds = find(cc > 0.04045);
%     cc(inds) = ( (cc(inds) + 0.055) ./ 1.055 ) .^ 2.4;
%     
%     inds = find(cc <= 0.04045);
%     cc(inds) = cc(inds) ./ 12.92;
%     
%     rgb(:, :, i) = cc .* 100;
% end

rgb = rgb .* 100;

xyz(:, :, 1) = rgb(:, :, 1).*M(1, 1) + rgb(:, :, 2).*M(2, 1) + rgb(:, :, 3).*M(3, 1);
xyz(:, :, 2) = rgb(:, :, 1).*M(1, 2) + rgb(:, :, 2).*M(2, 2) + rgb(:, :, 3).*M(3, 2);
xyz(:, :, 3) = rgb(:, :, 1).*M(1, 3) + rgb(:, :, 2).*M(2, 3) + rgb(:, :, 3).*M(3, 3);

end % function rgb2xyz